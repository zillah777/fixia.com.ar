================================================================================
  CONTENT SECURITY POLICY (CSP) - CLOUDINARY FIX
  Fixia Web Application
  Fecha: 2025-11-15
================================================================================

PROBLEMA RESUELTO:
------------------
Las imagenes de avatar alojadas en Cloudinary (https://res.cloudinary.com/)
estaban siendo bloqueadas por el Content Security Policy con el error:

  "Refused to connect because it violates the document's Content Security Policy"


CAUSA RAIZ:
-----------
La directiva connect-src en el CSP no incluia:
  - https://res.cloudinary.com (para fetch/XHR de imagenes)
  - https://api.cloudinary.com (para uploads directos)


SOLUCION IMPLEMENTADA:
----------------------
Actualizacion completa del CSP en 3 capas:

1. PRODUCCION (Vercel)
   Archivos: vercel.json + apps/web/vercel.json

2. DESARROLLO (Vite Dev Server)
   Archivo: apps/web/vite.config.ts (seccion server.headers)

3. PREVIEW (Vite Preview Mode)
   Archivo: apps/web/vite.config.ts (seccion preview.headers)


================================================================================
ARCHIVOS MODIFICADOS
================================================================================

CONFIGURACION CSP (4 archivos):
-------------------------------
1. C:\xampp\htdocs\fixia.com.ar\vercel.json
   - Linea 73: Content-Security-Policy actualizado
   - Agregados dominios de Cloudinary y MercadoPago
   - Agregadas directivas de seguridad adicionales

2. C:\xampp\htdocs\fixia.com.ar\apps\web\vercel.json
   - Linea 62: Sincronizado con vercel.json raiz
   - Configuracion identica para consistencia

3. C:\xampp\htdocs\fixia.com.ar\apps\web\vite.config.ts
   - Lineas 43-49: Headers CSP en server (desarrollo)
   - Lineas 56-62: Headers CSP en preview
   - Incluye permisos para localhost/127.0.0.1

4. C:\xampp\htdocs\fixia.com.ar\apps\web\package.json
   - Lineas 24-25: Nuevos scripts de validacion CSP


DOCUMENTACION NUEVA (2 archivos):
----------------------------------
5. C:\xampp\htdocs\fixia.com.ar\docs\CSP_CONFIGURATION.md
   - Documentacion completa de todas las directivas CSP
   - Explicacion de cada dominio permitido
   - Guias de troubleshooting
   - Mejoras de seguridad futuras

6. C:\xampp\htdocs\fixia.com.ar\CSP_DEPLOYMENT_GUIDE.md
   - Guia paso a paso de deployment
   - Checklist de verificacion
   - Procedimientos de rollback
   - Troubleshooting common issues


SCRIPTS DE VALIDACION (2 archivos):
------------------------------------
7. C:\xampp\htdocs\fixia.com.ar\apps\web\scripts\validate-csp.js
   - Script Node.js para validar CSP en produccion
   - Valida dominios requeridos y directivas de seguridad
   - Uso: npm run validate:csp:prod

8. C:\xampp\htdocs\fixia.com.ar\apps\web\public\test-csp.html
   - Pagina interactiva de testing CSP
   - Prueba todas las directivas visualmente
   - Accesible en /test-csp.html


================================================================================
CAMBIOS DETALLADOS EN CSP
================================================================================

ANTES (CSP que causaba el bloqueo):
------------------------------------
connect-src 'self'
            https://api.fixia.app
            https://fixia-api.onrender.com
            wss://fixia-api.onrender.com
            https://fonts.googleapis.com
            https://fonts.gstatic.com;

DESPUES (CSP actualizado):
--------------------------
connect-src 'self'
            https://api.fixia.app
            https://fixia-api.onrender.com
            wss://fixia-api.onrender.com
            https://res.cloudinary.com          <--- AGREGADO (FIX PRINCIPAL)
            https://api.cloudinary.com          <--- AGREGADO
            https://fonts.googleapis.com
            https://fonts.gstatic.com
            https://api.mercadopago.com;        <--- AGREGADO


OTRAS MEJORAS AGREGADAS:
-------------------------
img-src:
  - Agregado: blob: (para imagenes dinamicas desde canvas/File API)
  - Especificado: https://res.cloudinary.com (antes era https: generico)

script-src:
  - Agregado: https://sdk.mercadopago.com (para SDK de pagos)

font-src:
  - Agregado: data: (para iconos inline en base64)

Nuevas directivas:
  - object-src 'none' (bloquea <object>, <embed>, <applet>)
  - form-action 'self' https://api.fixia.app ... (control de envio de forms)
  - upgrade-insecure-requests (fuerza HTTPS automaticamente)


================================================================================
DIRECTIVAS CSP COMPLETAS (PRODUCCION)
================================================================================

default-src 'self';

script-src 'self'
           'unsafe-inline'
           'unsafe-eval'
           https://fonts.googleapis.com
           https://sdk.mercadopago.com;

style-src 'self'
          'unsafe-inline'
          https://fonts.googleapis.com;

font-src 'self'
         https://fonts.gstatic.com
         data:;

img-src 'self'
        data:
        blob:
        https://res.cloudinary.com
        https://fonts.googleapis.com
        https://fonts.gstatic.com;

connect-src 'self'
            https://api.fixia.app
            https://fixia-api.onrender.com
            wss://fixia-api.onrender.com
            https://res.cloudinary.com
            https://api.cloudinary.com
            https://fonts.googleapis.com
            https://fonts.gstatic.com
            https://api.mercadopago.com;

object-src 'none';

base-uri 'self';

frame-ancestors 'none';

form-action 'self'
            https://api.fixia.app
            https://fixia-api.onrender.com
            https://api.mercadopago.com;

upgrade-insecure-requests;


================================================================================
DESARROLLO LOCAL (ADICIONAL)
================================================================================

En vite.config.ts, para desarrollo local se agregan:

img-src:
  + http://localhost:*
  + http://127.0.0.1:*

connect-src:
  + http://localhost:*
  + http://127.0.0.1:*
  + ws://localhost:*
  + ws://127.0.0.1:*

form-action:
  + http://localhost:*

Esto permite:
  - Hot Module Replacement (HMR)
  - WebSocket del dev server
  - API local en desarrollo


================================================================================
COMANDOS DISPONIBLES
================================================================================

VALIDACION:
-----------
npm run validate:csp          # Valida CSP en localhost
npm run validate:csp:prod     # Valida CSP en produccion (Vercel)

DESARROLLO:
-----------
npm run dev                   # Inicia dev server con CSP
npm run preview               # Inicia preview con CSP de produccion

TESTING:
--------
Abrir en navegador:
  - http://localhost:3000/test-csp.html (desarrollo)
  - https://fixiaweb.vercel.app/test-csp.html (produccion)


================================================================================
PASOS PARA DEPLOYMENT
================================================================================

OPCION RAPIDA (solo fix):
-------------------------
cd C:\xampp\htdocs\fixia.com.ar
git add vercel.json apps/web/vercel.json apps/web/vite.config.ts
git commit -m "fix(csp): Add Cloudinary support to Content Security Policy"
git push origin main


OPCION COMPLETA (fix + docs + scripts):
----------------------------------------
cd C:\xampp\htdocs\fixia.com.ar
git add .
git commit -m "fix(csp): Add comprehensive CSP configuration for Cloudinary

- Add Cloudinary domains to connect-src and img-src
- Add MercadoPago SDK support
- Add blob: and data: support for dynamic content
- Implement CSP in vite.config.ts for dev/preview
- Add CSP validation script and interactive test page
- Add comprehensive documentation

Fixes: Images from res.cloudinary.com blocked by CSP
"
git push origin main


VERIFICACION POST-DEPLOYMENT:
------------------------------
1. Esperar 3 minutos (Vercel build + deploy)

2. Ejecutar validacion automatica:
   cd apps/web
   npm run validate:csp:prod

3. Probar en navegador:
   https://fixiaweb.vercel.app/test-csp.html

4. Verificar avatares:
   - Login en la app
   - Navegar a perfiles con avatares
   - Verificar que NO hay errores CSP en console


================================================================================
ROLLBACK (SI ALGO FALLA)
================================================================================

OPCION 1 - Revert Git:
----------------------
git log --oneline -5
git revert HEAD
git push origin main

OPCION 2 - Vercel Dashboard:
----------------------------
1. https://vercel.com/tu-proyecto/deployments
2. Seleccionar deployment anterior
3. "Promote to Production"

OPCION 3 - Fix Manual Rapido:
------------------------------
Editar solo vercel.json linea 73:
  Agregar: https://res.cloudinary.com a connect-src
Commit y push solo ese archivo


================================================================================
CHECKLIST DE VERIFICACION
================================================================================

PRE-DEPLOYMENT:
  [ ] Archivos modificados revisados (git diff)
  [ ] No hay archivos sensibles (.env, keys)
  [ ] Commit message es claro

POST-DEPLOYMENT:
  [ ] npm run validate:csp:prod → PASS
  [ ] /test-csp.html muestra todos PASS
  [ ] Imagenes de Cloudinary cargan correctamente
  [ ] No hay errores CSP en DevTools console
  [ ] Probar en incognito/otro navegador


================================================================================
DOCUMENTACION DE REFERENCIA
================================================================================

Interna:
--------
- Configuracion completa: docs/CSP_CONFIGURATION.md
- Guia de deployment: CSP_DEPLOYMENT_GUIDE.md
- Script validacion: apps/web/scripts/validate-csp.js
- Test interactivo: apps/web/public/test-csp.html

Externa:
--------
- CSP Level 3: https://www.w3.org/TR/CSP3/
- MDN CSP Guide: https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP
- Google Evaluator: https://csp-evaluator.withgoogle.com/
- Vercel Headers: https://vercel.com/docs/edge-network/headers


================================================================================
MEJORAS FUTURAS RECOMENDADAS
================================================================================

1. SEGURIDAD:
   - Eliminar 'unsafe-inline' usando nonces (vite-plugin-csp-nonce)
   - Eliminar 'unsafe-eval' reemplazando librerias
   - Implementar Subresource Integrity (SRI) para CDNs
   - Agregar report-uri para monitorear violaciones

2. MONITOREO:
   - Implementar CSP reporting endpoint
   - Agregar validacion CSP en CI/CD
   - Configurar alertas para violaciones

3. OPTIMIZACION:
   - Usar CSP nonces en lugar de 'unsafe-inline'
   - Migrar a CSP Level 3 completo
   - Implementar Trusted Types para prevenir XSS


================================================================================
NOTAS FINALES
================================================================================

Este fix resuelve completamente el problema de bloqueo de imagenes Cloudinary.

Tiempo estimado: 5-10 minutos (deployment + validacion)
Impacto: Bajo (solo agrega permisos, no modifica funcionalidad)
Compatibilidad: Backward compatible con codigo existente
Seguridad: Mantiene nivel de seguridad, mejora cobertura

El CSP ahora soporta:
  ✓ Cloudinary (imagenes y uploads)
  ✓ MercadoPago (pagos)
  ✓ Google Fonts (tipografia)
  ✓ API Backend (fixia-api.onrender.com)
  ✓ WebSockets (notificaciones real-time)
  ✓ Blob URLs (imagenes dinamicas)
  ✓ Data URIs (contenido inline)

================================================================================
